<div class="budgets-container">
  <div class="header">
    <h1>Budget Management</h1>
  </div>

  <div class="budgets-grid">
    <mat-card *ngFor="let budget of budgets" class="budget-card">
      <mat-card-header>
        <mat-card-title>{{ getMonthName(budget.month) }} {{ budget.year }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="budget-summary">
          <p><strong>Total Income:</strong> {{ formatCurrency(budget.totalIncome) }}</p>
          <p><strong>Total Budgeted:</strong> {{ formatCurrency(getTotalBudgeted(budget)) }}</p>
        </div>
        <div class="categories-list">
          <h4>Categories:</h4>
          <ul>
            <li *ngFor="let category of budget.categories">
              <span class="category-name">{{ category.category }}</span>
              <span class="category-limit">{{ formatCurrency(category.limit) }}</span>
            </li>
          </ul>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button color="primary" (click)="openEditDialog(budget)">
          <mat-icon>edit</mat-icon>
          Edit
        </button>
        <button mat-button color="warn" (click)="deleteBudget(budget.id)">
          <mat-icon>delete</mat-icon>
          Delete
        </button>
      </mat-card-actions>
    </mat-card>

    <div *ngIf="budgets.length === 0 && !isLoading" class="empty-state">
      <mat-icon>account_balance_wallet</mat-icon>
      <p>No budgets created yet. Create your first budget to get started!</p>
    </div>
  </div>

  <!-- Budget Form -->
  <div class="form-container">
    <h2>{{ isEditMode ? 'Edit Budget' : 'Create New Budget' }}</h2>
    <form [formGroup]="budgetForm" (ngSubmit)="saveBudget()">
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Month</mat-label>
          <mat-select formControlName="month">
            <mat-option *ngFor="let month of months; let i = index" [value]="i + 1">
              {{ month }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="budgetForm.get('month')?.hasError('required')">
            Month is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Year</mat-label>
          <input matInput type="number" formControlName="year" min="2000" max="2100">
          <mat-error *ngIf="budgetForm.get('year')?.hasError('required')">
            Year is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Total Income</mat-label>
          <input matInput type="number" formControlName="totalIncome" step="0.01" min="0.01">
          <mat-error *ngIf="budgetForm.get('totalIncome')?.hasError('required')">
            Total income is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Categories FormArray -->
      <div class="categories-section">
        <div class="categories-header">
          <h3>Budget Categories</h3>
          <button mat-button type="button" (click)="addCategory()">
            <mat-icon>add</mat-icon>
            Add Category
          </button>
        </div>

        <div formArrayName="categories" class="categories-list-form">
          <div *ngFor="let category of categoriesFormArray.controls; let i = index" 
               [formGroupName]="i" 
               class="category-item">
            <mat-form-field appearance="outline">
              <mat-label>Category</mat-label>
              <mat-select formControlName="category">
                <mat-option *ngFor="let cat of categories" [value]="cat">
                  {{ cat }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="category.get('category')?.hasError('required')">
                Category is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Limit</mat-label>
              <input matInput type="number" formControlName="limit" step="0.01" min="0.01">
              <mat-error *ngIf="category.get('limit')?.hasError('required')">
                Limit is required
              </mat-error>
            </mat-form-field>

            <button mat-icon-button type="button" color="warn" (click)="removeCategory(i)" 
                    [disabled]="categoriesFormArray.length === 1">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button mat-raised-button type="submit" color="primary" [disabled]="budgetForm.invalid || categoriesFormArray.length === 0">
          {{ isEditMode ? 'Update Budget' : 'Create Budget' }}
        </button>
        <button mat-button type="button" (click)="budgetForm.reset()">Cancel</button>
      </div>
    </form>
  </div>
</div>

